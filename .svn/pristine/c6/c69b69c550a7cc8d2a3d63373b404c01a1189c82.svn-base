package com.grampus.hualauncherkai.service;

import android.annotation.SuppressLint;
import android.app.KeyguardManager;
import android.app.Notification;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.graphics.BitmapFactory;
import android.hardware.display.VirtualDisplay;
import android.media.MediaCodec;
import android.media.MediaCodecInfo;
import android.media.MediaFormat;
import android.media.projection.MediaProjection;
import android.media.projection.MediaProjectionManager;
import android.os.Build;
import android.os.IBinder;
import android.os.PowerManager;
import android.util.DisplayMetrics;
import android.util.Log;
import android.view.Surface;
import android.view.WindowManager;

import androidx.annotation.Nullable;
import androidx.annotation.RequiresApi;
import androidx.core.app.NotificationCompat;

import com.grampus.hualauncherkai.Data.AndroidParameter;
import com.grampus.hualauncherkai.Data.NetDataHub;
import com.grampus.hualauncherkai.TcpSock.TcpSocketClient;

import java.net.InetAddress;
import java.net.UnknownHostException;
import java.nio.ByteBuffer;

import static com.grampus.hualauncherkai.R.mipmap.ic_launcher;

/**
 * Created by sih on 2017-05-31.
 */
@RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)
public final class ScreenCastService extends Service {

    private static final int FPS = 1;  //帧率
    private final String TAG = "EMMScreenCastService";

    private MediaProjectionManager mediaProjectionManager;

    private TcpSocketClient tcpSocketClient;

    private MediaProjection mediaProjection;
    private Surface inputSurface;
    private VirtualDisplay virtualDisplay;
    private MediaCodec.BufferInfo videoBufferInfo;
    private MediaCodec encoder;

    private InetAddress remoteHost;
    private int remotePort;

    public static ScreenCastService mScreenCastService;
/*
    //单例
    private static ScreenCastService instance;
 //   private ScreenCastService (){}                //设为私有会闪退

    public static ScreenCastService getInstance() {
        if (instance == null) {
            instance = new ScreenCastService();
        }
        return instance;
    }
*/

    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        return null;
    }

    /**
     * 设置应用服务未前台，前台通知展示
     */
    private void setForeground() {
        try{
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                NotificationChannel channel = new NotificationChannel("Foreground_Service",
                        "Foreground_Service", NotificationManager.IMPORTANCE_LOW);
                NotificationManager manager =
                        (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
                if (manager == null) {
                    return;
                }
                manager.createNotificationChannel(channel);
                Notification notification =
                        new NotificationCompat.Builder(this, "Foreground_Service")
                                .setContentTitle("阳途移动终端安全管理")
                                .setContentText("正在运行中")
                                .setWhen(System.currentTimeMillis())
                                .setSmallIcon(ic_launcher)
                                .setLargeIcon(BitmapFactory.decodeResource(getResources(), ic_launcher))
                                .build();
                startForeground(12, notification);
            }  /* .setAutoCancel(true)
                    .setCategory(Notification.CATEGORY_SERVICE)
                    .setOngoing(true)
                    .setPriority(NotificationManager.IMPORTANCE_LOW)*/
        }catch (Exception e){
            Log.i(TAG, "setForeground--error "+e.toString());
        }
    }

    /**
     * 锁屏下点亮屏幕
     */
    @SuppressLint("InvalidWakeLockTag")
    private void wakeAndUnlock()
    {
        try{
            PowerManager pm;
            PowerManager.WakeLock wl;

            pm=(PowerManager) getSystemService(Context.POWER_SERVICE);
            //获取PowerManager.WakeLock对象，后面的参数|表示同时传入两个值
            wl = pm.newWakeLock(PowerManager.ACQUIRE_CAUSES_WAKEUP | PowerManager.SCREEN_BRIGHT_WAKE_LOCK, "bright");
            //点亮屏幕
            wl.acquire();
        }catch (Exception e){
            Log.i(TAG, "wakeAndUnlock--error "+e.toString());
        }
    }
    /**
     * 30秒唤醒一次屏幕
     */
    public void wakeOnTime() {
        try{
            while(true){

                android.app.KeyguardManager mKeyguardManager = (KeyguardManager) getSystemService(Context.KEYGUARD_SERVICE);

                Log.i("EMMScreen", "wakeAndUnlock----检测是否黑屏-------");
                if(mKeyguardManager.isKeyguardLocked())
                {
                    Log.i("EMMScreen", "wakeAndUnlock----黑屏点亮屏幕-------");
                    wakeAndUnlock();

                    KeyguardManager.KeyguardLock kl = mKeyguardManager.newKeyguardLock("unLock");
                    kl.disableKeyguard();
                }

                Thread.sleep(30000);
                if(ScreenCastService.mScreenCastService==null)
                {
                    break;
                }

            }
        }catch (Exception e){
            Log.i("EMMScreen", "wakeAndUnlock--error "+e.toString());
        }
    }


    @Override
    public void onCreate() {
        super.onCreate();
        NetDataHub.get().addLog("ScreenCastService-----Screen Service--onCreate");
        Log.d("EMMScreen", "Screen Service--onCreate");
        mediaProjectionManager = (MediaProjectionManager) getSystemService(Context.MEDIA_PROJECTION_SERVICE);
        System.out.println("onCreate----------begin  threadid:"+android.os.Process.myTid());

    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        NetDataHub.get().addLog("ScreenCastService---Screen Service---onDestroy");
        Log.d("EMMScreen", "Screen Service--onDestroy");
        stopScreenCapture();
    }


    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        if (intent == null) {
            return START_NOT_STICKY;
        }

        NetDataHub.get().addLog("ScreenCastService---onStartCommand---begin");
 /*       try
        {
            Notification.Builder builder = new Notification.Builder(this.getApplicationContext()); //获取一个Notification构造器
            Intent nfIntent = new Intent(getApplication(), MainActivity.class);
            builder.setContentIntent(PendingIntent.
                    getActivity(this, 0, nfIntent, 0)) // 设置PendingIntent
                    .setLargeIcon(BitmapFactory.decodeResource(this.getResources(),
                            R.mipmap.ico3)) // 设置下拉列表中的图标(大图标)
                    .setContentTitle("下拉列表中的Title") // 设置下拉列表里的标题
                    .setSmallIcon(R.mipmap.ic_launcher) // 设置状态栏内的小图标
                    .setContentText("要显示的内容") // 设置上下文内容
                    .setWhen(System.currentTimeMillis()); // 设置该通知发生的时间
            Notification notification = builder.build(); // 获取构建好的Notification
            notification.defaults = Notification.DEFAULT_SOUND; //设置为默认的声音

            startForeground(1, notification);

            Log.w("OnReceivePack", "startForeground ------" );
        } catch (Exception e) {
            Log.e(TAG, "Failed to Start, e: " + e);
        }*/

        try{
            final String remoteHost = AndroidParameter.serverIp;
           // remotePort = 6671;
            try {
                this.remoteHost = InetAddress.getByName(remoteHost);
            } catch (UnknownHostException e) {
                e.printStackTrace();
                return START_NOT_STICKY;
            }


            DisplayMetrics dm =new DisplayMetrics();
            WindowManager manager = (WindowManager) getSystemService(Context.WINDOW_SERVICE);
            manager.getDefaultDisplay().getRealMetrics(dm);

            int widthPixels = dm.widthPixels;//单位为像素 px
            int heightPixels = dm.heightPixels;//单位为像素 px
            float density = dm.density;
            float scaledDensity = dm.scaledDensity;
            int densityDpi = dm.densityDpi;
            Log.i("EMMScreen",  "width,height,density,scaledDensity,densityDpi：" + widthPixels+ "," +heightPixels+ "," + density + "," + scaledDensity+ "," +densityDpi  );

            final int screenWidth = (int)(dm.widthPixels/dm.density);    //432
            final int screenHeight = (int)( dm.heightPixels/dm.density); // 872
            final  int screenDpi = dm.densityDpi;

            final String format = "video/avc";
            final int bitrate = 12*1024*1000;

            AndroidParameter.width = screenWidth ;
            AndroidParameter.hight = screenHeight ;
            AndroidParameter.density = dm.density;
            AndroidParameter.densityDpi = screenDpi ;

            NetDataHub.get().addLog("ScreenCastService---onStartCommand---a");
            Log.w("EMMScreen", "Start casting with format:" + format + ", screen:" + screenWidth +"x"+screenHeight +" @ " + screenDpi + " bitrate:" + bitrate);
             if (!createSocket()) {
                Log.e("EMMScreen", "Failed to connect tcp:" + remoteHost + ":" + remotePort);
                return START_NOT_STICKY;

            }

            final int resultCode = -1;
            final Intent resultData = intent.getParcelableExtra("RESULT_DATA");

           // Intent resultDat =new Intent
            Log.i("EMMScreen", "resultCode: " + resultCode + " resultData:" + resultData+ " resultData.ts:" +"RESULT_DATA");

            if (resultCode == 0 || resultData == null) {
                return  START_NOT_STICKY;
            }

            mScreenCastService = this;
            new Thread(new Runnable(){

                @Override
                public void run() {
                    startScreenCapture(resultCode, resultData, format, screenWidth, screenHeight, screenDpi, bitrate);
                }
            }).start();

           // startScreenCapture(format, screenWidth, screenHeight, screenDpi, bitrate);

            NetDataHub.get().addLog("ScreenCastService---nStartCommand---b");
            new Thread(new Runnable(){

                @Override
                public void run() {
                    wakeOnTime();
                }
            }).start();
            return START_STICKY;
        }catch(Exception e){
            NetDataHub.get().addLog("ScreenCastService----onStartCommand--Error:"+e.toString());
            return  START_NOT_STICKY;
        }
        //return START_REDELIVER_INTENT;
    }
/*
    private static MediaCodecInfo selectCodec(String mimeType) {
        // 获取所有支持编解码器数量
        int numCodecs = MediaCodecList.getCodecCount();
        for (int i = 0; i < numCodecs; i++) {
            // 编解码器相关性信息存储在MediaCodecInfo中
            MediaCodecInfo codecInfo = MediaCodecList.getCodecInfoAt(i);
            // 判断是否为编码器
            Log.w("EMM","numCodecs="+numCodecs+" | mName"+codecInfo.getName());
            if (!codecInfo.isEncoder()) {
                continue;
            }
            // 获取编码器支持的MIME类型，并进行匹配
            String[] types = codecInfo.getSupportedTypes();
            for (int j = 0; j < types.length; j++) {
                Log.w("EMM","types.length="+types.length+" | types[j]:"+types[j]);

                if (types[j].equalsIgnoreCase(mimeType)) {
                    return codecInfo;
                }
            }
        }
        return null;
    }
*/
    private void startScreenCapture(int resultCode, Intent resultData, String format, int width, int height, int dpi, int bitrate) {

        NetDataHub.get().addLog("ScreenCastService---start---开始屏幕监视");
        //MediaPlayer MediaPlayer = new MediaPlayer();

        setForeground();
        try {
            int i = 0;
            while(!(tcpSocketClient.isConnectOK))
            {
                Log.i("EMMScreen", " width:"+width+" height:"+height+"dpi:"+dpi+"-------slepp 10");
                Thread.sleep(10);
                if(i++>500) {
                    stopScreenCapture();
                    break;
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            NetDataHub.get().addLog("ScreenCastService---start while() error:"+ e.toString());
        }

   //     Log.i("EMMScreen", " width:"+width+" height:"+height+" dpi:"+dpi);
        try {
            this.mediaProjection = mediaProjectionManager.getMediaProjection(resultCode, resultData);
        }catch (Exception e){
            NetDataHub.get().addLog("ScreenCastService---start error:"+ e.toString());
            Log.e( "OnReceivePack", e.toString());
        }
        this.videoBufferInfo = new MediaCodec.BufferInfo();
        MediaFormat mediaFormat = MediaFormat.createVideoFormat(format, width, height);

        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);
        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, 25);
        mediaFormat.setInteger(MediaFormat.KEY_CHANNEL_COUNT, 0);
        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 50);  // 配置GOP大小

        //mediaFormat.setInteger(MediaFormat.KEY_REPEAT_PREVIOUS_FRAME_AFTER, 40);画面禁止一段时间后发送FRAME
        mediaFormat.setInteger(MediaFormat.KEY_BITRATE_MODE, MediaCodecInfo.EncoderCapabilities.BITRATE_MODE_CBR);

        try {
            // AVC

            NetDataHub.get().addLog("ScreenCastService---start---mediaFormat设置参数");
            Log.d( "OnReceivePack", "MIMETYPE_VIDEO_AVC.....");
            mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);

            this.encoder = MediaCodec.createEncoderByType(format);

            this.encoder.setCallback(new MediaCodec.Callback() {
                @Override
                public void onInputBufferAvailable(MediaCodec codec, int inputBufferId) {

                    if( AndroidParameter.g_testCount < 6){
                //        NetDataHub.get().addLog("ScreenCastService---InputAvailable");
                    }
                }

                @Override
                public void onOutputBufferAvailable(MediaCodec codec, int outputBufferId, MediaCodec.BufferInfo info) {
                    try {


                        ByteBuffer outputBuffer = codec.getOutputBuffer(outputBufferId);


                        if( AndroidParameter.g_testCount < 6) {
                        //    NetDataHub.get().addLog("ScreenCastService---OutputAvailable");
                        }
                        if (info.size > 0 && outputBuffer != null) {
                            //Log.d( "OnReceivePack", "onOutputBufferAvailable.....outputBuffer");
                            int nBufSize = outputBuffer.remaining();        //返回剩余的可用长度，此长度为实际读取的数据长度，最大自然是底层数组的长度
                            outputBuffer.position(info.offset);
                            outputBuffer.limit(info.offset + info.size);
                            byte[] b = new byte[outputBuffer.remaining()];
                            outputBuffer.get(b);        //,读取缓冲区当前位置的值,然后递增，返回当前缓冲区位置上的值

                        //    AndroidParameter.g_testCount++;

                            sendData(null, b);
                            try {
                                Thread.sleep(5);
                            } catch (Exception e) {
                                e.printStackTrace();
                            }
                            //---------------------
                            //System.out.println("onOutputBufferAvailable-----DataSize:" + nBufSize + "  threadid:" + android.os.Process.myTid());
                        }
                        if (encoder != null && outputBufferId > 0) {
                            encoder.releaseOutputBuffer(outputBufferId, false);

                        }
                      /*
                       if(videoBufferInfo!=null)
                        {
                            if ((videoBufferInfo.flags & MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0) {
                                Log.i("OnReceivePack", "End of Stream");
                                stopScreenCapture();
                            }
                        }
                        */
                    }catch(Exception e){
                        Log.e("EMMScreen", "onOutputBufferAvailable--error-"+e.toString());
                        //ScreenCastService.mScreenCastService.onDestroy();
                        stopScreenCapture();

                    }
                }

                @Override
                public void onError(MediaCodec codec, MediaCodec.CodecException e) {
                    e.printStackTrace();
                }

                @Override
                public void onOutputFormatChanged(MediaCodec codec, MediaFormat format) {
                    Log.i(TAG, "onOutputFormatChanged. CodecInfo:" + codec.getCodecInfo().toString() + " MediaFormat:" + format.toString());
                }
            });
            this.encoder.configure(mediaFormat
                                    , null // surface
                                    , null // crypto
                                    , MediaCodec.CONFIGURE_FLAG_ENCODE);

            this.inputSurface = this.encoder.createInputSurface();
            this.encoder.start();

        } catch (Exception e) {
            NetDataHub.get().addLog("ScreenCastService---start error:"+e.toString());
            //Log.e(TAG, "Failed to initial encoder, e: " + e);
            releaseEncoders();
        }

        try{
            this.virtualDisplay = this.mediaProjection.createVirtualDisplay("Recording Display", width, height, dpi, 0, this.inputSurface, null, null);
        }catch (Exception e)
        {
            NetDataHub.get().addLog("ScreenCastService---virtualDisplay error:"+e.toString());
        }
   }

    private void sendData(byte[] header, byte[] data) {

        if(tcpSocketClient != null) {
            if(header != null) {
                tcpSocketClient.send(header);
            }
            tcpSocketClient.send(data);

            if( AndroidParameter.g_testCount < 6) {
            //    NetDataHub.get().addLog("sendData--------1");
            }
        }
        else{
            NetDataHub.get().addLog("远程传输失败，关闭远程连接");
            stopScreenCapture();
        }
    }

    private void stopScreenCapture() {
        try{
            releaseEncoders();

            AndroidParameter.screenCapture = false;
            if(ScreenCastService.mScreenCastService!=null)
            {
                NetDataHub.get().addLog("ScreenCastService---退出屏幕录制");
                ScreenCastService.mScreenCastService = null;
            }
            closeSocket();
            stopForeground(true);
            if (virtualDisplay == null) {
                return;
            }
            virtualDisplay.release();
            virtualDisplay = null;
        }catch (Exception e){
            Log.i("EMMScreen", "stopForeground---error "+e.toString());
            NetDataHub.get().addLog("ScreenCastService---stop error"+e.toString());
        }
    }

    private void releaseEncoders() {
        try{
            if (encoder != null) {
                encoder.stop();
                encoder.release();
                encoder = null;
            }
            if (inputSurface != null) {
                inputSurface.release();
                inputSurface = null;
            }
            if (mediaProjection != null) {
                mediaProjection.stop();
                mediaProjection = null;
            }
            videoBufferInfo = null;
        }catch (Exception e){
            Log.i("EMMScreen", "releaseEncoders--error "+e.toString());
            NetDataHub.get().addLog("ScreenCastService---releaseEncoders error"+e.toString());
        }
    }

    private boolean createSocket() {
        tcpSocketClient = new TcpSocketClient(remoteHost, remotePort);
        tcpSocketClient.start();
        NetDataHub.get().addLog("ScreenCastService---createSocket");
        return true;
    }

    private void closeSocket() {
        if(tcpSocketClient != null) {
            Log.w("EMMScreen", "关闭远程连接");
            try {
                tcpSocketClient.close();
            } catch(Exception ex) {
                ex.printStackTrace();
            } finally {
                tcpSocketClient = null;
            }
        }
    }

}
